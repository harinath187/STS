{% extends "base.html" %}

{% block title %}Support History{% endblock %}

{% block content %}

<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/css/bootstrap.min.css" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap4.min.css" />
<link rel="stylesheet" href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap4.min.css" />

<style>
  table#notAssignTable thead th {
    background-color: black !important;
    color: white !important;
  }
</style>

<div class="flex min-h-screen">
  <aside class="w-64 bg-white shadow-md flex flex-col fixed top-0 left-0 bottom-0">
    {% include "common/it_manager.html" %}
  </aside>

  <main class="flex-1 ml-64 mt-0 p-6 bg-gray-50">
    <h1 class="text-2xl font-semibold mb-6">Welcome {{ user.firstname }}</h1>

    <div class="table-responsive">
      <table id="notAssignTable" class="table table-striped table-bordered dt-responsive nowrap" style="width:100%">
        <thead>
          <tr>
            <th>Assigned To</th>
            <th>Assigned By</th>
            <th>Department Name</th>
            <th>Duration</th>
            <th>Problem Description</th>
            <th>Priority</th>
            <th>Status</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for notassign in notassignlist %}
          <tr data-ticket-id="{{ notassign.id }}">
            <td>{{ notassign.assignto }}</td>
            <td>{{ notassign.assignby }}</td>
            <td>{{ notassign.dept_name }}</td>
            <td>{{ notassign.duration }}</td>
            <td>{{ notassign.problem_description }}</td>
            <td>{{ notassign.priority }}</td>
            <td>{{ notassign.status }}</td>
            <td>
              <button class="btn btn-sm btn-primary edit-btn">Edit</button>
              <button class="btn btn-sm btn-danger delete-btn">Delete</button>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </main>
</div>


<div class="modal fade" id="editTicketModal" tabindex="-1" aria-labelledby="editTicketModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="editTicketForm">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Edit Support Ticket</h5>
          <button type="button" class="close" data-dismiss="modal">&times;</button>
        </div>
        <div class="modal-body">
          
          <input type="hidden" id="ticketId">

          <div class="form-group">
            <label for="assignto">Assigned To</label>
            <select class="form-control" id="assignto" name="assignto" required>
              <option value="">Select Employee</option>
            </select>
          </div>

          <div class="form-group">
            <label for="assignby">Assigned By</label>
            <input type="text" class="form-control" id="assignby" name="assignby" readonly>
          </div>

          <div class="form-group">
            <label for="dept_name">Department</label>
            <input type="text" class="form-control" id="dept_name" readonly>
          </div>

          <div class="form-group">
            <label for="duration">Duration</label>
            <input type="text" class="form-control" id="duration" name="duration" required>
          </div>

          <div class="form-group">
            <label for="comments">Comments</label>
            <textarea class="form-control" id="comments" name="comments" rows="2" readonly></textarea>
          </div>

          <div class="form-group">
            <label for="problem_description">Problem Description</label>
            <textarea class="form-control" id="problem_description" name="problem_description" rows="3" readonly></textarea>
          </div>

          <div class="form-group">
            <label for="priority">Priority</label>
            <select class="form-control" id="priority" name="priority" readonly>
              <option value="">Select Priority</option>
              <option value="Low">Low</option>
              <option value="Medium">Medium</option>
              <option value="High">High</option>
              <option value="Critical">Critical</option>
            </select>
          </div>

          <div class="form-group">
            <label for="start_date">Start Date</label>
            <input type="date" class="form-control" id="start_date" name="start_date" readonly>
          </div>

          <div class="form-group">
            <label for="status">Status</label>
            <select class="form-control" id="status" name="status" readonly>
              <option value="OPEN">OPEN</option>
              <option value="RESOLVED">RESOLVED</option>
              <option value="CLOSED">CLOSED</option>
            </select>
          </div>

        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-primary">Update Ticket</button>
        </div>
      </div>
    </form>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://code.jquery.com/jquery-3.5.1.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.3/dist/js/bootstrap.bundle.min.js" crossorigin="anonymous"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap4.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap4.min.js"></script>

<script>
  var loggedInUserId = {{ user.id }};  // Ensure user.id is passed into template

  $(document).ready(function () {
    var table = $('#notAssignTable').DataTable({
      responsive: true,
      paging: true,
      searching: true,
      ordering: true,
      info: true,
      lengthChange: true,
      pageLength: 10
    });

    
    $('#notAssignTable tbody').on('click', '.edit-btn', function () {
      var tr = $(this).closest('tr');
      var ticketId = tr.data('ticket-id');

      $.ajax({
        url: '/ticket/' + ticketId,
        method: 'GET',
        success: function (data) {
          console.log("Fetched ticket data:", data);

          $('#ticketId').val(ticketId);
          $('#assignby').val(data.assignby_name || '');

          $('#dept_name').val(data.dept_name || '').data('dept-id', data.dept_id);

          $('#duration').val(data.duration || '');
          $('#comments').val(data.comments || '');
          $('#problem_description').val(data.problem_description || '');

          $('#priority').val(data.Priority || '');

          var formattedDate = '';
          if (data.Start_Date) {
            formattedDate = new Date(data.Start_Date).toISOString().split('T')[0];
          }
          $('#start_date').val(formattedDate);

          $('#status').val(data.status || '');

          
          $.ajax({
            url: '/employees/' + encodeURIComponent(data.dept_name),
            method: 'GET',
            success: function (employees) {
              var $assignto = $('#assignto');
              $assignto.empty();
              $assignto.append('<option value="">Select Employee</option>');
              employees.forEach(function (emp) {
                var fullName = emp.firstname + ' ' + emp.lastname;
                var selected = (emp.id === data.assigned_to) ? 'selected' : '';
                $assignto.append('<option value="' + emp.id + '" ' + selected + '>' + fullName + '</option>');
              });
            },
            error: function () {
              alert('Failed to load employees for department.');
            }
          });

          $('#editTicketModal').modal('show');
        },
        error: function (xhr) {
          console.error("Error fetching ticket:", xhr.responseText);
          alert('Error fetching ticket data.');
        }
      });
    });

    
    $('#editTicketForm').on('submit', function (e) {
      e.preventDefault();
      var ticketId = $('#ticketId').val();
      var dept_id = $('#dept_name').data('dept-id');

      var formData = {
        assigned_to: parseInt($('#assignto').val()) || null,
        assigned_by: loggedInUserId,
        dept_id: parseInt(dept_id),
        duration: $('#duration').val().trim(),
        comments: $('#comments').val().trim(),
        problem_description: $('#problem_description').val().trim(),
        priority: $('#priority').val().trim(),
        start_date: $('#start_date').val(),
        status: $('#status').val()
      };

      console.log("Submitting updated ticket data:", formData);

      var missing = [];
      for (var key in formData) {
        if (formData[key] === null || formData[key] === '') {
          missing.push(key);
        }
      }
      if (missing.length > 0) {
        alert('Missing required: ' + missing.join(', '));
        return;
      }

      $.ajax({
        url: '/ticket/' + ticketId,
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify(formData),
        success: function (response) {
          alert(response.message || 'Ticket updated successfully!');
          $('#editTicketModal').modal('hide');
          location.reload();
        },
        error: function (xhr) {
          console.error("Update error:", xhr.responseText);
          var err = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : xhr.responseText;
          alert('Update failed: ' + err);
        }
      });
    });

    // Delete route
    $('#notAssignTable tbody').on('click', '.delete-btn', function () {
      if (!confirm('Are you sure to delete this ticket?')) return;

      var tr = $(this).closest('tr');
      var ticketId = tr.data('ticket-id');

      $.ajax({
        url: '/ticket/' + ticketId + '/delete',
        method: 'POST',
        success: function (response) {
          alert(response.message);
          location.reload();
        },
        error: function (xhr) {
          var err = xhr.responseJSON && xhr.responseJSON.error ? xhr.responseJSON.error : xhr.responseText;
          alert('Delete failed: ' + err);
        }
      });
    });

  });
</script>
{% endblock %}
